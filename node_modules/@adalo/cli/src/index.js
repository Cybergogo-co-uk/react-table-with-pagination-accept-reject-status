require('dotenv').config()
require('colors')
const axios = require('axios')
const { execSync } = require('child_process')

const build = require('./build')
const publish = require('./publish')
const dev = require('./dev')
const login = require('./login')
const update = require('./update')

const panic = (msg) => {
  console.error(`ERROR:`, msg)
  process.exit(1)
}

const execute = (command, args, opts) => {
  let commands = {
    build,
    publish,
    dev,
    login,
    update,
  }

  if (!commands[command]) {
    panic(`No command "${command}"`, true)
  }

  if (command !== 'login') {
    const { authToken } = require('./lib/auth')
    const token = authToken(opts.local)

    // set defaults
    axios.defaults.headers['x-proton-auth'] = token
    axios.defaults.maxBodyLength = 1000000000
    axios.defaults.maxContentLength = 1000000000
  }

  // Execute command
  commands[command](args, opts)
    .catch(err => panic(`Unexpected error: ${err}`))
}

module.exports = {
  execute,
}
